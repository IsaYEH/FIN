<!doctype html>
<html lang="zh-Hant" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Market UI Pro</title>
  <script>
    // Tailwind dark mode via class
    if(localStorage.getItem('theme') === 'dark'){
      document.documentElement.classList.add('dark');
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
  <style>
    :root { color-scheme: light dark; }
    .card { @apply rounded-2xl border shadow-sm p-4 bg-white border-slate-200 dark:bg-slate-900 dark:border-slate-700; }
    .label { @apply text-sm font-medium text-slate-700 dark:text-slate-200; }
    .input { @apply mt-1 w-full rounded-xl border border-slate-300 p-2 bg-white text-slate-900 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100; }
    .btn { @apply rounded-xl px-4 py-2 transition; }
    .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700; }
    .btn-ghost { @apply bg-slate-200 text-slate-800 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600; }
    .muted { @apply text-sm text-slate-600 dark:text-slate-400; }
  </style>
</head>
<body class="h-full bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
  <div class="max-w-7xl mx-auto p-4 md:p-8 space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold">Market UI Pro</h1>
        <p class="muted">å¤šæª”ç–Šåœ–ï½œè‚¡åˆ©æ¨™è¨˜ï½œæš—è‰²æ¨¡å¼ï½œRender API å¾Œç«¯</p>
      </div>
      <button id="toggleTheme" class="btn btn-ghost" title="åˆ‡æ›æ·±è‰²/æ·ºè‰²">ğŸŒ“</button>
    </header>

    <section class="grid md:grid-cols-2 lg:grid-cols-4 gap-3">
      <label class="block">
        <span class="label">API Base URL</span>
        <input id="apiBase" class="input" value="https://fin-rhwp.onrender.com" />
      </label>
      <label class="block lg:col-span-2">
        <span class="label">è‚¡ç¥¨ä»£è™Ÿï¼ˆé€—è™Ÿåˆ†éš”ï¼š2330.TW,AAPL,SPYï¼‰</span>
        <input id="symbols" class="input" value="2330.TW,AAPL" />
      </label>
      <div class="flex items-end gap-2">
        <label class="block flex-1">
          <span class="label">Start</span>
          <input id="start" type="date" class="input" />
        </label>
        <label class="block flex-1">
          <span class="label">End</span>
          <input id="end" type="date" class="input" />
        </label>
      </div>
      <div class="flex items-end gap-3 lg:col-span-4">
        <button id="btnFetch" class="btn btn-primary">æŸ¥è©¢</button>
        <button id="btnTW" class="btn btn-ghost">ETF_TW ç¯„ä¾‹</button>
        <button id="btnUS" class="btn btn-ghost">ETF_US ç¯„ä¾‹</button>
        <label class="flex items-center gap-2 ml-2 text-sm">
          <input id="useAdj" type="checkbox" class="h-4 w-4" checked>
          ä½¿ç”¨ adj_close ç¹ªåœ–
        </label>
        <label class="flex items-center gap-2 ml-2 text-sm">
          <input id="showDiv" type="checkbox" class="h-4 w-4" checked>
          é¡¯ç¤ºè‚¡åˆ©æ¨™è¨˜
        </label>
        <span id="status" class="muted"></span>
      </div>
    </section>

    <section class="grid lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 card">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-medium">åƒ¹æ ¼ç–Šåœ–</h2>
          <span class="muted text-xs">æ”¯æ´å¤šæª” & adj_close</span>
        </div>
        <div class="h-[420px]"><canvas id="priceChart" height="380"></canvas></div>
      </div>

      <div class="card">
        <h2 class="font-medium mb-2">åŸºæœ¬è³‡è¨Šï¼ˆç¬¬ä¸€æª”ï¼‰</h2>
        <dl id="infoBox" class="text-sm grid grid-cols-3 gap-2">
          <dt class="muted">åç¨±</dt><dd id="longName" class="col-span-2">â€”</dd>
          <dt class="muted">ä»£è™Ÿ</dt><dd id="sym" class="col-span-2">â€”</dd>
          <dt class="muted">äº¤æ˜“æ‰€</dt><dd id="exchange" class="col-span-2">â€”</dd>
          <dt class="muted">å¹£åˆ¥</dt><dd id="currency" class="col-span-2">â€”</dd>
          <dt class="muted">å¸‚å€¼</dt><dd id="marketCap" class="col-span-2">â€”</dd>
          <dt class="muted">ç”¢æ¥­</dt><dd id="industry" class="col-span-2">â€”</dd>
          <dt class="muted">éƒ¨é–€</dt><dd id="sector" class="col-span-2">â€”</dd>
        </dl>
      </div>
    </section>

    <section class="card">
      <h2 class="font-medium mb-3">è‚¡åˆ©ç´€éŒ„ï¼ˆç¬¬ä¸€æª”ï¼‰</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 dark:bg-slate-800">
            <tr>
              <th class="text-left px-3 py-2">æ—¥æœŸ</th>
              <th class="text-left px-3 py-2">ç¾é‡‘è‚¡åˆ©</th>
            </tr>
          </thead>
          <tbody id="divTable"></tbody>
        </table>
      </div>
    </section>

    <footer class="muted">
      å»ºç½®æ™‚é–“ï¼š<span id="builtAt"></span> ï½œ Chart.js + Tailwind ï½œ å¾Œç«¯ï¼šä½ çš„ Render API
    </footer>
  </div>

<script>
const $ = (q)=>document.querySelector(q);
const palette = [
  "#2563eb","#16a34a","#f59e0b","#ef4444","#8b5cf6",
  "#0ea5e9","#22c55e","#eab308","#f97316","#ec4899"
];

function fmtCap(n){
  if(!n && n!==0) return "â€”";
  const units=[["T",1e12],["B",1e9],["M",1e6]];
  for(const [label, val] of units){
    if(n>=val) return (n/val).toFixed(2)+label;
  }
  return new Intl.NumberFormat().format(n);
}
function todayStr(){
  const t=new Date(); const m=("0"+(t.getMonth()+1)).slice(-2); const d=("0"+t.getDate()).slice(-2);
  return `${t.getFullYear()}-${m}-${d}`;
}
function setDefaults(){
  $("#start").value = "2020-01-01";
  $("#end").value = todayStr();
}

async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return await r.json();
}

async function loadInfo(base, symbol){
  try{
    const info = await fetchJSON(`${base}/api/public/info?symbol=${encodeURIComponent(symbol)}`);
    $("#longName").textContent = info.longName || "â€”";
    $("#sym").textContent = info.symbol || symbol;
    $("#exchange").textContent = info.exchange || "â€”";
    $("#currency").textContent = info.currency || "â€”";
    $("#marketCap").textContent = fmtCap(info.marketCap);
    $("#industry").textContent = info.industry || "â€”";
    $("#sector").textContent = info.sector || "â€”";
  }catch(e){ console.error(e); }
}

async function loadDividends(base, symbol, start, end){
  const divBox = $("#divTable");
  divBox.innerHTML = "";
  try{
    const rows = await fetchJSON(`${base}/api/public/dividends?symbol=${encodeURIComponent(symbol)}&start=${start}&end=${end}`);
    if(!rows.length){ divBox.innerHTML = `<tr><td class="px-3 py-2" colspan="2">ç„¡è³‡æ–™</td></tr>`; return; }
    divBox.innerHTML = rows.map(r=>`<tr class="border-b border-slate-100 dark:border-slate-800">
      <td class="px-3 py-2">${r.date}</td><td class="px-3 py-2">${r.cash}</td></tr>`).join("");
    return rows;
  }catch(e){
    divBox.innerHTML = `<tr><td class="px-3 py-2 text-red-600" colspan="2">${e.message}</td></tr>`;
    return [];
  }
}

async function loadOHLCV(base, symbol, start, end){
  const url = `${base}/api/public/ohlcv?symbol=${encodeURIComponent(symbol)}&start=${start}&end=${end}&limit=20000`;
  const data = await fetchJSON(url);
  return data.filter(x=>x.date && (x.adj_close!=null || x.close!=null));
}

function makeChart(ctx){
  const dark = document.documentElement.classList.contains("dark");
  return new Chart(ctx, {
    type: "line",
    data: { datasets: [] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { type: "time", time: { unit: "month" },
             ticks: { color: dark ? "#94a3b8" : "#475569" },
             grid: { color: dark ? "rgba(148,163,184,0.15)" : "rgba(100,116,139,0.15)" } },
        y: { beginAtZero: false,
             ticks: { color: dark ? "#94a3b8" : "#475569" },
             grid: { color: dark ? "rgba(148,163,184,0.15)" : "rgba(100,116,139,0.15)" } },
      },
      plugins: {
        legend: { labels: { color: dark ? "#e2e8f0" : "#0f172a" } },
        tooltip: {
          mode: "nearest",
          intersect: false,
          callbacks: {
            label: (ctx)=> `${ctx.dataset.label}: ${ctx.parsed.y}`
          }
        }
      },
      elements: { point: { radius: 0 } }
    }
  });
}

function rebuildScalesColors(chart){
  const dark = document.documentElement.classList.contains("dark");
  const scx = chart.options.scales.x, scy = chart.options.scales.y;
  scx.ticks.color = scy.ticks.color = dark ? "#94a3b8" : "#475569";
  scx.grid.color = scy.grid.color = dark ? "rgba(148,163,184,0.15)" : "rgba(100,116,139,0.15)";
  chart.options.plugins.legend.labels.color = dark ? "#e2e8f0" : "#0f172a";
  chart.update();
}

function buildDatasets(allSeries, useAdj, showDiv){
  const datasets = [];
  allSeries.forEach((serie, idx)=>{
    const color = palette[idx % palette.length];
    const points = serie.rows.map(x=>({x: new Date(x.date), y: useAdj ? x.adj_close ?? x.close : x.close ?? x.adj_close})).filter(p=>p.y!=null);
    datasets.push({
      label: serie.symbol,
      data: points,
      borderColor: color,
      backgroundColor: color,
      tension: 0.2
    });
    if(showDiv && serie.divs && serie.divs.length){
      // å°‡è‚¡åˆ©æ¨™åœ¨æ”¶ç›¤åƒ¹ä½ç½®ï¼ˆåŒæ—¥æ‰¾ä¸åˆ°å°±ç•¥éï¼‰
      const priceByDate = new Map(serie.rows.map(r=>[r.date, (useAdj ? (r.adj_close ?? r.close) : (r.close ?? r.adj_close))]));
      const divPts = [];
      for(const d of serie.divs){
        const y = priceByDate.get(d.date);
        if(y!=null) divPts.push({x: new Date(d.date), y});
      }
      datasets.push({
        label: serie.symbol + " dividends",
        type: "scatter",
        data: divPts,
        pointRadius: 3,
        pointHoverRadius: 5,
        borderColor: color,
        backgroundColor: color,
        showLine: false
      });
    }
  });
  return datasets;
}

let chart;

async function run(){
  const base = $("#apiBase").value.trim().replace(/\/$/,"");
  const symbols = $("#symbols").value.split(",").map(s=>s.trim()).filter(Boolean);
  const start = $("#start").value;
  const end = $("#end").value;
  const useAdj = $("#useAdj").checked;
  const showDiv = $("#showDiv").checked;

  $("#status").textContent = "Loading...";
  try{
    const allSeries = [];
    for(const sym of symbols){
      const rows = await loadOHLCV(base, sym, start, end);
      let divs = [];
      try{ divs = await fetchJSON(`${base}/api/public/dividends?symbol=${encodeURIComponent(sym)}&start=${start}&end=${end}`); }catch(e){}
      allSeries.push({ symbol: sym, rows, divs });
    }

    // åŸºæœ¬è³‡è¨Šé¡¯ç¤ºç¬¬ä¸€æª”
    if(symbols.length){
      loadInfo(base, symbols[0]);
      loadDividends(base, symbols[0], start, end);
    }

    const ctx = document.getElementById("priceChart").getContext("2d");
    if(!chart){ chart = makeChart(ctx); }
    chart.data.datasets = buildDatasets(allSeries, useAdj, showDiv);
    chart.update();

    $("#status").textContent = "OK";
  }catch(e){
    console.error(e);
    $("#status").textContent = "Error: " + e.message;
    alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
  }
}

async function loadUniverse(market){
  const base = $("#apiBase").value.trim().replace(/\/$/,"");
  try{
    const js = await fetchJSON(`${base}/api/public/universe?market=${encodeURIComponent(market)}`);
    if(js.symbols && js.symbols.length){
      $("#symbols").value = js.symbols.slice(0,3).join(",");
      run();
    }
  }catch(e){ console.error(e); }
}

document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("builtAt").textContent = new Date().toISOString();
  setDefaults();
  $("#btnFetch").addEventListener("click", run);
  $("#btnTW").addEventListener("click", ()=>loadUniverse("ETF_TW"));
  $("#btnUS").addEventListener("click", ()=>loadUniverse("ETF_US"));
  $("#toggleTheme").addEventListener("click", ()=>{
    const root = document.documentElement;
    const toDark = !root.classList.contains("dark");
    root.classList.toggle("dark", toDark);
    localStorage.setItem('theme', toDark ? 'dark' : 'light');
    if(chart) rebuildScalesColors(chart);
  });
});
</script>
</body>
</html>
